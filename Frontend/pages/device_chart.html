<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimum-scale=1.0, maximum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>空气质量监测系统-设备统计图表</title>
    <meta name="keywords" content="">
    <meta name="description" content="">

	<link rel="stylesheet" href="../assets/mdui/css/mdui.min.css">
	<link rel="stylesheet" href="../assets/docs.css">
	<!--link rel="stylesheet" href="./assets/bootstrap.min.css">
    <link rel="stylesheet" href="./assets/bootstrap-theme.min.css">
    <link rel="stylesheet" href="./assets/waterSupply.css">


    <script src="./assets/bootstrap.min.js" type="text/javascript"></script>
    <script src="./assets/jquery-websocket.js" type="text/javascript"></script--!>


    <!--link rel="stylesheet" href="main.css"-->

</head>
<body class="mdui-bottom-nav-fixed mdui-appbar-with-toolbar mdui-theme-primary-indigo mdui-theme-accent-pink mdui-loaded">
<header class="mdui-appbar mdui-appbar-fixed">
	<div class="mdui-toolbar mdui-color-theme">
		<span onclick="window.location.href='./chart'" class="mdui-btn mdui-btn-icon mdui-ripple mdui-ripple-white">
			<i class="mdui-icon material-icons">&#xe5c4;</i>
        </span>
		<a href="" class="mdui-typo-title">传感器设备</a>
		<div class="mdui-toolbar-spacer"></div>
	</div>
</header>

<div id="loading" class="mdui-spinner" style="position: absolute;left: 50%;top: 50%;z-index: 100;"></div>
<div class="mdui-container doc-container doc-no-cover">
	<h1 class="doc-title mdui-text-color-theme">设备统计图表</h1>
	<p id="dev_id"></p>

	<div class="mdui-card">
		<div class="mdui-card-actions">
			<div class="mdui-row">
                <div id="tab" class="mdui-tab mdui-tab-centered" mdui-tab>
                    <a href="#" class="mdui-tab-active mdui-ripple">实时</a>
                    <a href="#" class="mdui-ripple">近 24 小时</a>
                    <a href="#" class="mdui-ripple">近 7 天</a>
                    <a href="#" class="mdui-ripple">近 30 天</a>
                </div>
				<div id="container"></div>
			</div>
		</div>
	</div>
</div>

<script src="../assets/jquery.min.js" type="text/javascript"></script>
<script src="../assets/mdui/js/mdui.min.js" type="text/javascript"></script>
<script src="../assets/sensor_devices.js" type="text/javascript"></script>
<script src="../assets/highcharts.js" type="text/javascript"></script>
<script src="../assets/highcharts-more.js" type="text/javascript"></script>

<script type="text/javascript">
    var dev_id;
    // 获取 JSON 数据，数据文件地址：
    //https://github.com/highcharts/highcharts/blob/master/samples/data/activity.json
    $(document).ready(function () {
        $("#loading").hide();
        dev_id = getQueryString("dev_id");
        $("#dev_id").html("当前设备ID："+dev_id);
        getDeviceChart(dev_id, 0);
    });


    Highcharts.setOptions({ global: { useUTC: false } });
    document.getElementById('tab').addEventListener('change.mdui.tab', function (event) {
        console.log('event: change; tab: ' + event.detail.index);
        getDeviceChart(dev_id, event.detail.index);
    });
	function getDeviceChart(dev_id,type){
        $("#loading").show();
        $.get('../api/device/getDeviceChart?dev_id='+dev_id+"&type="+type, function (activity) {
            $('#container').empty();
            $.each(activity.datasets, function (i, dataset) {
                // 添加 X 数据
                dataset.data = Highcharts.map(dataset.data, function (val, j) {
                    return eval([activity.xData[j], val]);
                });
                $('<div class="chart">')
                    .appendTo('#container')
                    .highcharts({
                        chart: {
                            marginLeft: 40, // Keep all charts left aligned
							//height: 500,
                            spacingTop: 5,
                            spacingBottom: 5,
                            zoomType: 'x'
                        },
                        title: {
                            text: dataset.name,
                            align: 'left',
                            margin: 0,
                            x: 30
                        },
                        credits: {
                            enabled: false
                        },
                        legend: {
                            enabled: false
                        },
                        xAxis: {
                            type: 'datetime',
                            crosshair: true,
                            events: {
                                setExtremes: syncExtremes
                            },
                            dateTimeLabelFormats: {
                                hour: '%H:%M',
                                day: '%m-%d',
                                millisecond: '%H:%M:%S',
                            }
                        },
                        yAxis: {
                            min: dataset.min,
							max: dataset.max,
                            title: {
                                text: null
                            }
                        },
                        tooltip: {
                            positioner: function () {
                                return {
                                    x: this.chart.chartWidth - this.label.width, // right aligned
                                    y: -1 // align to title
                                };
                            },
                            borderWidth: 0,
                            backgroundColor: 'none',
                            pointFormat: '{point.y}',
                            headerFormat: '',
                            shadow: false,
                            style: {
                                fontSize: '18px'
                            },
                            valueDecimals: dataset.valueDecimals
                        },
                        plotOptions: {
                            series: {
                                marker: {
                                    enabled: false
                                }
                            }
                        },
                        series: [{
                            data: dataset.data,
                            name: dataset.name,
                            type: dataset.type,
                            color: Highcharts.getOptions().colors[i+2],
                            fillOpacity: 0.3,
                            tooltip: {
                                valueSuffix: ' ' + dataset.unit
                            }
                        }]
                    });
            });
            $("#loading").hide();
        });
    }



    /**
     * 为了让多个图表的提示框即十字准星线能够联动，这里绑定多个图表的附件 dom 的鼠标事件进行联动
     */
    $('#container').bind('mousemove touchmove touchstart', function (e) {
        var chart,
            point,
            i,
            event;
        for (i = 0; i < Highcharts.charts.length; i = i + 1) {
            chart = Highcharts.charts[i];
            event = chart.pointer.normalize(e.originalEvent); // Find coordinates within the chart
            point = chart.series[0].searchPoint(event, true); // Get the hovered point
            if (point) {
                point.highlight(e);
            }
        }
    });
    /**
     * 重写内部的方法， 这里是将提示框即十字准星的隐藏函数关闭
     */
    Highcharts.Pointer.prototype.reset = function () {
        return undefined;
    };
    /**
     * 高亮当前的数据点，并设置鼠标滑动状态及绘制十字准星线
     */
    Highcharts.Point.prototype.highlight = function (event) {
        this.onMouseOver(); // 显示鼠标激活标识
        this.series.chart.tooltip.refresh(this); // 显示提示框
        this.series.chart.xAxis[0].drawCrosshair(event, this); // 显示十字准星线
    };
    /**
     * 同步缩放效果，即当一个图表进行了缩放效果，其他图表也进行缩放
     */
    function syncExtremes(e) {
        var thisChart = this.chart;
        if (e.trigger !== 'syncExtremes') {
            Highcharts.each(Highcharts.charts, function (chart) {
                if (chart !== thisChart) {
                    if (chart.xAxis[0].setExtremes) {
                        chart.xAxis[0].setExtremes(e.min, e.max, undefined, false, { trigger: 'syncExtremes' });
                    }
                }
            });
        }
    }

</script>

</body>
<script src="../assets/footer.js" type="text/javascript"></script>
</html>
